<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="./images/favicon.ico" />
    <title>高德地图</title>
    <style>
      html,
      body,
      #container {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      .search_box {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 999;
      }
    </style>
    <!-- 加载地图JSAPI脚本 -->
    <script type="text/javascript">
      window._AMapSecurityConfig = {
        serviceHost: "https://static.zhangsifan.com/_AMapService",
      };
    </script>
    <script
      type="text/javascript"
      src="https://webapi.amap.com/maps?v=2.0&key=534ae1864b35d216683d7000f9533c3b"
    ></script>
  </head>
  <body>
    <div id="container"></div>
    <div class="search_box">
      <input
        id="input_id"
        v-model="keyword"
        style="width: 200px"
        placeholder="输入名称进行搜索"
      />
      <button onclick="window.open('/car_track.html','_blank')">
        轨迹回放
      </button>
    </div>
    <script>
      let marker = null;
      let geocoder = null;
      var map = new AMap.Map("container", {
        viewMode: "2D",
        zoom: 15,
        resizeEnable: true,
      });
      map.on("click", (e) => {
        addMarker(e.lnglat.lng, e.lnglat.lat);
      });
      // 输入提示插件
      AMap.plugin("AMap.AutoComplete", () => {
        var autoOptions = {
          input: "input_id",
        };
        var autoComplete = new AMap.AutoComplete(autoOptions);
        autoComplete.on("select", (e) => {
          try {
            addMarker(e.poi.location.lng, e.poi.location.lat);
          } catch (error) {
            console.error("此地点未找到");
          }
        });
      });
      // 浏览器定位
      AMap.plugin("AMap.Geolocation", function () {
        var geolocation = new AMap.Geolocation({
          enableHighAccuracy: true, // 是否使用高精度定位，默认：true
          timeout: 10000, // 设置定位超时时间，默认：无穷大
          offset: [10, 20], // 定位按钮的停靠位置的偏移量
          zoomToAccuracy: true, //  定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
          position: "RB", //  定位按钮的排放位置,  RB表示右下
        });
        map.addControl(geolocation);
        geolocation.getCurrentPosition(function (status, result) {
          if (status == "complete") {
            onComplete(result);
          } else {
            onError(result);
          }
        });

        function onComplete(data) {
          console.log("浏览器定位信息：", {
            定位结果: data.position,
            定位类别: data.location_type,
            精度: data.accuracy ? data.accuracy + " 米" : "无",
            是否经过偏移: data.isConverted ? "是" : "否",
            原始信息: data,
          });
        }

        function onError(data) {
          console.log("浏览器定位失败", data);
        }
      });
      // ip定位
      AMap.plugin("AMap.CitySearch", function () {
        var citySearch = new AMap.CitySearch();
        citySearch.getLocalCity(function (status, result) {
          console.log("ip定位结果：", status, result);
          if (status === "complete" && result.info === "OK") {
            // 查询成功，result即为当前所在城市信息
            console.log("IP定位城市信息：", result);
          }
        });
      });
      //加载地理编码插件
      AMap.plugin(["AMap.Geocoder"], function () {
        geocoder = new AMap.Geocoder({
          radius: 1000, //以已知坐标为中心点，radius为半径，返回范围内兴趣点和道路信息
          extensions: "all", //返回地址描述以及附近兴趣点和道路信息，默认“base”
        });
        geocoder.on("complete", (e) => {
          console.log("地理编码结果：", e.regeocode);
        });
      });

      function addMarker(lng, lat) {
        if (marker) {
          marker.setMap(null);
          marker = null;
        }
        marker = new AMap.Marker({
          position: [lng, lat],
        });
        marker.setMap(map);
        map.setCenter([lng, lat]);
        geocoder.getAddress(new AMap.LngLat(lng, lat));
      }
    </script>
  </body>
</html>
